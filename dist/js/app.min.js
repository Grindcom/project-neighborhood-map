/**
 * Neighborhood Map project
 * Main JavaScript
 * Author: Greg Ford, B.Sc.
 * Start Date: Dec. 13, 2016
 * And Still going in 2017
 */
var view_model,map_global,mapStyles=[{featureType:"water",stylers:[]},{featureType:"administrative",elementType:"labels.text.stroke",stylers:[{weight:2}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{lightness:-40}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{lightness:-40}]},{featureType:"transit.station",stylers:[{weight:9},{hue:"#262CAD"}]},{featureType:"transit.station",elementType:"labels.icon",stylers:[{visibility:"on"}]},{featureType:"landscape.man_made",elementType:"geometry.fill",stylers:[{lightness:20}]},{featureType:"landscape.natural",elementType:"geometry.fill",stylers:[]}],durations=[{value:"10",text:"10 min"},{value:"15",text:"15 min"},{value:"30",text:"30 min"},{value:"60",text:"1 hour"}],modes=[{value:"DRIVING",text:"drive"},{value:"WALKING",text:"walk"},{value:"BICYCLING",text:"bike"},{value:"TRANSIT",text:"transit ride"}],favSpots=[{name:"Oliver Street Bar and Grill",type:"Pub",address:"23 Oliver St, Williams Lake, BC",geoLocation:"",reviews:[],imgSrc:"",imgAttribution:""},{name:"Mings Palace",type:"Restaurant",address:"12 Oliver Street, Williams Lake, BC",geoLocation:"",reviews:[],imgSrc:"",imgAttribution:""},{name:"Bean Counter Bistro & Coffee Bar",type:"Bistro",address:"Suite B 180 3rd Ave N, Williams Lake, BC",geoLocation:"",reviews:[],imgSrc:"",imgAttribution:""},{name:"Overlander Pub",type:"Pub",address:"1118 Lakeview Crescent, Williams Lake, BC",geoLocation:"",reviews:[],imgSrc:"",imgAttribution:""},{name:"The Laughing Loon",type:"Pub",address:"1730 Broadway Ave S, Williams Lake, BC",geoLocation:"",reviews:[],imgSrc:"",imgAttribution:""}],CoolSpot=function(a,b){this.id=b,this.clickCount=ko.observable(0),this.name=ko.observable(a.name),this.selected=!1,this.address=ko.observable(a.address),this.type=ko.observable(a.type),this.geoLocation=ko.observable(a.geoLocation),this.markerColor="070B57",this.markerHighlightColor="FFFF24",this.imgSrc=a.imgSrc,this.imgAttribution=a.imgAttribution,this.marker=null,this.markerVisible=ko.observable(!1),this.nameAndCount=ko.computed(function(){return this.name()+" | "+this.clickCount()+" Likes"},this),this.likes=ko.computed(function(){return" | "+this.clickCount()+" Likes"},this)},ViewModel=function(){var a=this;view_model=this,this.defaultSpotTitle="Cool Spots",this.spotTitle=ko.observable(this.defaultSpotTitle),this.largeInfowindow=null,this.polygon=null,this.drawingManager=null,this.DRAWPOLY="Draw a Filter Area Polygon",this.CLEARPOLY="Clear Polygon",this.sketchToggleValue=ko.observable(this.DRAWPOLY),this.zoomed=!1,this.ZOOMIN="Zoom to Your Area",this.ZOOMOUT="Zoom Back",this.zoomText=this.ZOOMIN,this.timeSearchText=ko.observable(""),this.placeMarkers=ko.observableArray([]),this.timeOptions=ko.observableArray([]),durations.forEach(function(b){a.timeOptions.push(b)}),this.selectedTime=ko.observable(null),this.travelModes=ko.observableArray([]),modes.forEach(function(b){a.travelModes.push(b)}),this.selectedMode=ko.observable(""),this.spotList=[],this.filteredSpotList=ko.observableArray([]);var b=0;favSpots.forEach(function(c){var d=new CoolSpot(c,b++);a.spotList.push(d),a.filteredSpotList.push(d)}),this.currentSpot=ko.observable(a.spotList[0]),this.nearbyList=ko.observableArray([]),this.nearbyCount=0,this.addNearbySpots=function(b){a.nearbyList.push(b)},this.getNearbyList=function(){return this.nearbyList()},this.clearNearbyList=function(){for(;this.nearbyList().length>0;)this.nearbyList.pop()},this.compileNearbyList=function(){return log.console("Compiling List of selected favorite places..."),a.clearNearbyList(),a.spotList.forEach(function(b){b.selected&&a.nearbyList.push(b)}),a.clearNearbyList().length>0?"Your Selected List: ":"Nothing Selected"},this.UPARROW="⟰",this.DOWNARROW="⟱",this.LEFTARROW="⇚",this.RIGHTARROW="⇛",this.menuToggleArrow=ko.observable(this.LEFTARROW);var c=new Slideout({panel:document.getElementById("main"),menu:document.getElementById("sidebar"),padding:256,tolerance:70,side:"right"}),d=document.querySelector(".fixed");c.on("beforeopen",function(){d.classList.add("fixed-open")}),c.on("beforeclose",function(){d.classList.remove("fixed-open")}),this.menuToggle=function(a,b){c.toggle(),this.menuToggleArrow()===this.LEFTARROW?this.menuToggleArrow(this.RIGHTARROW):this.menuToggleArrow(this.LEFTARROW)};var e=null;this.routes=[],this.initMap=function(b){var c={lat:52.1417,lng:-122.1417};b=new google.maps.Map(document.getElementById("map"),{center:c,zoom:13,mapTypeControl:!0,mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},styles:mapStyles}),map_global=b;new google.maps.Marker({position:c,map:map_global,title:"Center of Williams Lake"});a.spotList.forEach(function(b){a.buildMarker(b)}),a.largeInfowindow=new google.maps.InfoWindow,a.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT,drawingModes:[google.maps.drawing.OverlayType.POLYGON]}}),a.drawingManager.addListener("overlaycomplete",function(b){a.polygon&&(a.polygon.setMap(null),a.hideMarkers(a.placeMarkers())),a.drawingManager.setDrawingMode(null),a.polygon=b.overlay,a.polygon.setEditable(!0),a.polygon.setDraggable(!0),a.searchWithinPolygon(),a.polygon.getPath().addListener("set_at",function(){a.searchWithinPolygon()}),a.polygon.getPath().addListener("insert_at",function(){a.searchWithinPolygon()})}),e=new google.maps.DirectionsService},this.getPlacesDetails=function(a,b){new google.maps.places.PlacesService(map_global).getDetails({placeId:a.id},function(c,d){if(d===google.maps.places.PlacesServiceStatus.OK){b.marker=a;var e="<div>";c.name&&(e+="<strong>"+c.name+"</strong>"),c.formatted_address&&(e+="<br>"+c.formatted_address),c.formatted_phone_number&&(e+="<br>"+c.formatted_phone_number),c.opening_hours&&(e+="<br><br><strong>Hours:</strong><br>"+c.opening_hours.weekday_text[0]+"<br>"+c.opening_hours.weekday_text[1]+"<br>"+c.opening_hours.weekday_text[2]+"<br>"+c.opening_hours.weekday_text[3]+"<br>"+c.opening_hours.weekday_text[4]+"<br>"+c.opening_hours.weekday_text[5]+"<br>"+c.opening_hours.weekday_text[6]+"<br>"),c.photos&&(e+='<br><br><img src="'+c.photos[0].getUrl({maxHeight:100,maxWidth:200})+'">'),b.setContent(e),b.open(map,a),b.addListener("closeclick",function(){b.marker=null})}})},this.populateInfoWindow=function(b){function e(c,d){if(d==google.maps.StreetViewStatus.OK){var e=c.location.latLng,f=google.maps.geometry.spherical.computeHeading(e,b.position);a.largeInfowindow.setContent("<div>"+b.title+'</div><div id="pano"></div>');var g={position:e,pov:{heading:f,pitch:10}};new google.maps.StreetViewPanorama(document.getElementById("pano"),g)}else a.largeInfowindow.setContent("<div>"+b.title+"</div><div>No Street View Found</div>")}if(a.largeInfowindow.marker!==b){a.largeInfowindow.marker=b,a.largeInfowindow.setContent("<div>"+b.title+"</div>"),a.largeInfowindow.open(map_global,b);(new google.maps.StreetViewService).getPanoramaByLocation(b.position,50,e),a.largeInfowindow.open(map_global,b)}},this.displayDirections=function(b){a.hideSpots();var c=a.timeSearchText(),d=a.selectedMode();e.route({origin:c,destination:b,travelMode:google.maps.TravelMode[d]},function(b,c){if(c===google.maps.DirectionsStatus.OK){var d=new google.maps.DirectionsRenderer({map:map_global,directions:b,draggable:!0,polylineOptions:{strokeColor:"green"}});a.routes.push(d)}else window.alert("Directions request failed due to "+c)})}};ViewModel.prototype.toggleSubMenu=function(a,b){var c=this,d=$(b.target).next();$(d).slideToggle(function(){var a=$(d).is(":visible"),e=$(b.target).children("span");a?e.text(c.UPARROW):e.text(c.DOWNARROW)}),"nearby-h3"===b.target.id&&(c.clearNearbyList(),c.spotList.forEach(function(a){a.selected&&c.queryFourSquare(a)}))},ViewModel.prototype.makeMarkerIcon=function(a){return new google.maps.MarkerImage("http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|"+a+"|40|_|%E2%80%A2",new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34),new google.maps.Size(21,34))},ViewModel.prototype.buildMarker=function(a){var b=this,c=new google.maps.Geocoder;""===a.address()?window.alert("Address: "+a.address()+", is not valid."):c.geocode({address:a.address()},function(c,d){if(d===google.maps.GeocoderStatus.OK){a.geoLocation(c[0].geometry.location);var e=b.makeMarkerIcon(a.markerColor),f=new google.maps.Marker({map:map_global,position:a.geoLocation(),title:a.name(),icon:e,animation:google.maps.Animation.DROP}),g=b.makeMarkerIcon(a.markerHighlightColor);f.addListener("mouseover",function(){this.setIcon(g),b.pulseMenuListItem(a.id)}),f.addListener("mouseout",function(){this.setIcon(e)}),f.addListener("click",function(){b.populateInfoWindow(this)}),a.marker=f}else window.alert("Could not find that location - try entering a more specific place")})},ViewModel.prototype.listClickHandler=function(a){var b=a.markerVisible();if(this.shakeNameMarker(a),b){var c=a.clickCount();a.clickCount(++c),this.populateInfoWindow(a.marker)}else a.markerVisible(!0)},ViewModel.prototype.menuListMouseout=function(a){if(a.markerVisible()){var b=this.makeMarkerIcon(a.markerColor);a.marker.setIcon(b)}},ViewModel.prototype.menuListHover=function(a){if(a.markerVisible()){var b=this.makeMarkerIcon(a.markerHighlightColor);a.marker.setIcon(b)}this.pulseMenuListItem(a.id)},ViewModel.prototype.pulseMenuListItem=function(a){$("#menu-list-"+a).animate({fontSize:"1.5em"}),$("#menu-list-"+a).animate({fontSize:"1em"})},ViewModel.prototype.shakeNameMarker=function(a){var b=this;a.marker.getMap()||a.marker.setMap(map_global),a.marker.getAnimation()===google.maps.Animation.BOUNCE?a.marker.setAnimation(google.maps.Animation.DROP):(a.marker.setAnimation(google.maps.Animation.BOUNCE),b.currentSpot(b.spotList[a.id]))},ViewModel.prototype.showSpots=function(){var a=new google.maps.LatLngBounds;this.spotList.forEach(function(b){b.marker.setMap(map_global),a.extend(b.marker.position)}),map_global.setCenter(a.getCenter()),map_global.fitBounds(a)},ViewModel.prototype.hideSpots=function(){this.spotList.forEach(function(a){a.marker.setMap(null),a.marker.setAnimation(google.maps.Animation.DROP)})},ViewModel.prototype.hideMarkers=function(a){a.forEach(function(a){a.setMap(null)})},ViewModel.prototype.toggleDrawing=function(){var a=this;this.drawingManager.map?(this.drawingManager.setMap(null),this.polygon&&(this.polygon.setMap(null),a.filteredSpotList.removeAll(),a.spotList.forEach(function(b){a.filteredSpotList.push(b)})),this.sketchToggleValue(this.DRAWPOLY)):(this.drawingManager.setMap(map_global),this.sketchToggleValue(this.CLEARPOLY))},ViewModel.prototype.zoomToArea=function(){var a=this,b=new google.maps.Geocoder;""===this.timeSearchText()?window.alert("Please ad an area or address"):b.geocode({address:this.timeSearchText()},function(b,c){c==google.maps.GeocoderStatus.OK?(map_global.setCenter(b[0].geometry.location),a.zoomed?(a.zoomed=!1,a.zoomText=a.ZOOMIN,map_global.setZoom(13)):(a.zoomed=!0,a.zoomText=a.ZOOMOUT,map_global.setZoom(16))):window.alert("Could not find that location - try entering a more specific place")})},ViewModel.prototype.displayMarkersWithinTime=function(a){var b=this,d=(a.originAddresses,a.destinationAddresses),e=!1,f=0;a.rows.forEach(function(a){a.elements.forEach(function(a){var c=null;if(!a.distance)return void window.alert("There are no cool spots in that area.");c=a.distance.text;var g=a.duration.value/60,h=a.duration.text;if(g<=b.selectedTime()){var i=null;f<b.spotList.length&&(i=b.spotList[f].marker,i.setMap(map_global)),e=!0;var j=new google.maps.InfoWindow({content:h+" away, about "+c+'<div><button type="button" id="display-directions" onClick="view_model.displayDirections(&quot;'+d[f]+'&quot;);">View Route</button></div>'});i&&(b.spotList[f].marker.infowindow=j,google.maps.event.addListener(i,"click",function(){i.infowindow.close()})),j.open(map_global,i)}f+=1})}),e||window.alert("Sorry, nothing found within your selected time window.")},ViewModel.prototype.searchWithinPolygon=function(){var a=this,b=[];a.spotList.forEach(function(c){google.maps.geometry.poly.containsLocation(c.marker.position,a.polygon)?(c.marker.setMap(map_global),a.spotTitle(a.defaultSpotTitle+" (filtered)"),b.push(c)):c.marker.setMap(null)}),b.length>0&&(a.spotTitle(a.defaultSpotTitle+" (filtered)"),a.filteredSpotList.removeAll(),b.forEach(function(b){a.filteredSpotList.push(b)}))},ViewModel.prototype.searchWithinTime=function(){var a=this,b=new google.maps.DistanceMatrixService;if(""===this.timeSearchText())window.alert("You need to enter an address");else{this.hideSpots();var c=[];this.spotList.forEach(function(a){c.push(a.marker.position)});var d=this.timeSearchText(),e=this.selectedMode();b.getDistanceMatrix({origins:[d],destinations:c,travelMode:google.maps.TravelMode[e],unitSystem:google.maps.UnitSystem.IMPERIAL},function(b,c){if(c!==google.maps.DistanceMatrixStatus.OK)window.alert("Error was: "+c);else{b.originAddresses,b.destinationAddresses;a.displayMarkersWithinTime(b)}})}},ViewModel.prototype.clearRoutes=function(){this.routes().forEach(function(a){a.setOptions({suppressMarkers:!0}),a.setMap(null)}),this.routes.removeAll()},ViewModel.prototype.textSearchPlaces=function(){var a=map_global.getBounds();this.hideMarkers(this.placeMarkers()),new google.maps.places.PlacesService(map).textSearch({query:document.getElementById("places-search").value,bounds:a},function(a,b){b===google.maps.places.PlacesServiceStatus.OK&&createMarkersForPlaces(a)})},ViewModel.prototype.createMarkersForPlaces=function(a){var b=new google.maps.LatLngBounds;a.forEach(function(a){var c={url:a.icon,size:new google.maps.Size(35,35),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(15,34),scaledSize:new google.maps.Size(25,25)},d=new google.maps.Marker({map:map_global,icon:c,title:a.name,position:a.geometry.location,id:a.place_id}),e=new google.maps.InfoWindow;d.addListener("click",function(){e.marker==this||getPlacesDetails(this,e)}),self.placeMarkers().push(d),a.geometry.viewport?b.union(a.geometry.viewport):b.extend(a.geometry.location),map_global.setCenter(b.getCenter()),map_global.fitBounds(b)})},ViewModel.prototype.queryFourSquare=function(a){var b=this,g=a.marker.position.lat()+","+a.marker.position.lng();$.getJSON("https://api.foursquare.com/v2/venues/search",{v:"20161016",ll:g,query:"",limit:5,intent:"checkin",client_id:"INWUJQCSABPNKFZPFSG1L1023VTHBFWBP4YZCUXUFQEO01MW",client_secret:"T5RHEMNEQBGGQ4ZYF5ESD4NA1J20OWGD5IWTFYT5R4N21JZX"}).done(function(a){a.response.venues.forEach(function(a){var c="No Category";a.categories.length>0&&a.categories.forEach(function(a){console.log("- "+a.name),c=a.name});var d={name:a.name,type:c,address:a.location.address,geoLocation:a.location.lat+","+a.location.lng,reviews:[],imgSrc:"",imgAttribution:""};b.addNearbySpots(d)})})},ko.applyBindings(new ViewModel);