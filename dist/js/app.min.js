/**
 * Neighborhood Map project
 * Main JavaScript
 * Author: Greg Ford, B.Sc.
 * Start Date: Dec. 13, 2016
 * And Still going in 2017
 */
var view_model;var MAP_GLOBAL;var mapStyles=[{featureType:'water',stylers:[]},{featureType:'administrative',elementType:'labels.text.stroke',stylers:[{weight:2}]},{featureType:'administrative',elementType:'labels.text.fill',stylers:[]},{featureType:'road.highway',elementType:'geometry.stroke',stylers:[{lightness:-40}]},{featureType:'road.highway',elementType:'geometry.fill',stylers:[{lightness:-40}]},{featureType:'transit.station',stylers:[{weight:9},{hue:'#262CAD'}]},{featureType:'transit.station',elementType:'labels.icon',stylers:[{visibility:'on'}]},{featureType:'landscape.man_made',elementType:'geometry.fill',stylers:[{lightness:20}]},{featureType:'landscape.natural',elementType:'geometry.fill',stylers:[]}];var durations=[{value:'10',text:'10 min'},{value:'15',text:'15 min'},{value:'30',text:'30 min'},{value:'60',text:'1 hour'}];var modes=[{value:'DRIVING',text:'drive'},{value:'WALKING',text:'walk'},{value:'BICYCLING',text:'bike'},{value:'TRANSIT',text:'transit ride'}];var favSpots=[{name:'Oliver Street Bar and Grill',type:'Pub',address:'23 Oliver St, Williams Lake, BC',geoLocation:'',closeTo:[""],imgSrc:'',imgAttribution:''},{name:'Sushi California',type:'Restaurant',address:'770 Oliver St, Williams Lake, BC',geoLocation:'',closeTo:[""],imgSrc:'',imgAttribution:''},{name:'Mings Palace',type:'Restaurant',address:'12 Oliver Street, Williams Lake, BC',geoLocation:'',closeTo:[""],imgSrc:'',imgAttribution:''},{name:'Bean Counter Bistro & Coffee Bar',type:'Bistro',address:'Suite B 180 3rd Ave N, Williams Lake, BC',geoLocation:'',closeTo:[""],imgSrc:'',imgAttribution:''},{name:'Overlander Pub',type:'Pub',address:'1118 Lakeview Crescent, Williams Lake, BC',geoLocation:'',closeTo:[""],imgSrc:'',imgAttribution:''},{name:'The Laughing Loon',type:'Pub',address:'1730 Broadway Ave S, Williams Lake, BC',geoLocation:'',closeTo:[""],imgSrc:'',imgAttribution:''}];var CoolSpot=function(data,id){this.id=id;this.clickCount=ko.observable(0);this.name=ko.observable(data.name);this.selected=false;this.address=ko.observable(data.address);this.type=ko.observable(data.type);this.geoLocation=ko.observable(data.geoLocation);this.closeTo=ko.observableArray([]);this.markerColor='070B57';this.markerHighlightColor='FFFF24';this.imgSrc=data.imgSrc;this.imgAttribution=data.imgAttribution;this.marker=null;this.markerVisible=ko.observable(false);this.nameAndCount=ko.computed(function(){return this.name()+" | "+this.clickCount()+" Likes";},this);this.likes=ko.computed(function(){return" | "+this.clickCount()+" Likes";},this);};var ViewModel=function(){var self=this;view_model=this;this.defaultSpotTitle='Cool Spots';this.spotTitle=ko.observable(this.defaultSpotTitle);this.largeInfowindow=null;this.polygon=null;this.drawingManager=null;this.DRAWPOLY='Draw a Filter Area Polygon';this.CLEARPOLY='Clear Polygon';this.sketchToggleValue=ko.observable(this.DRAWPOLY);this.zoomed=false;this.ZOOMIN='Zoom to Your Area';this.ZOOMOUT='Zoom Back';this.zoomText=this.ZOOMIN;this.timeSearchText=ko.observable('');this.placeMarkers=ko.observableArray([]);this.timeOptions=ko.observableArray([]);durations.forEach(function(duration){self.timeOptions.push(duration);});this.selectedTime=ko.observable(null);this.travelModes=ko.observableArray([]);modes.forEach(function(mode){self.travelModes.push(mode);});this.selectedMode=ko.observable('');this.spotList=[];this.filteredSpotList=ko.observableArray([]);var i=0;favSpots.forEach(function(location){var spot=new CoolSpot(location,i++);self.spotList.push(spot);self.filteredSpotList.push(spot);});this.currentSpot=ko.observable(self.spotList[0]);this.nearbyList=ko.observableArray([]);this.nearbyCount=0;this.addNearbySpots=function(spot){self.nearbyList.push(spot);};this.getNearbyList=function(){return this.nearbyList();};this.clearNearbyList=function(){while(this.nearbyList().length>0){this.nearbyList.pop();}};this.compileNearbyList=function(){self.clearNearbyList();self.spotList.forEach(function(spot){if(spot.selected){self.nearbyList.push(spot);}});return self.clearNearbyList().length>0?"Your Selected List: ":"Nothing Selected";};this.UPARROW='\u27F0';this.DOWNARROW='\u27F1';this.LEFTARROW="\u21DA";this.RIGHTARROW='\u21DB';this.menuToggleArrow=ko.observable(this.LEFTARROW);var slideout=new Slideout({'panel':document.getElementById('main'),'menu':document.getElementById('sidebar'),'padding':256,'tolerance':70,'side':'right'});var blockFixed=document.querySelector('.fixed');slideout.on('beforeopen',function(){blockFixed.classList.add('fixed-open');});slideout.on('beforeclose',function(){blockFixed.classList.remove('fixed-open');});this.menuToggle=function(data,event){slideout.toggle();if(this.menuToggleArrow()===this.LEFTARROW){this.menuToggleArrow(this.RIGHTARROW);}else{this.menuToggleArrow(this.LEFTARROW);}};var directionsService=null;this.routes=[];this.initMap=function(map){var williams_lake={lat:52.1417,lng:-122.1417};map=new google.maps.Map(document.getElementById('map'),{center:williams_lake,zoom:13,mapTypeControl:true,mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},zoomControl:true,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},streetViewControl:true,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},styles:mapStyles});MAP_GLOBAL=map;var marker=new google.maps.Marker({position:williams_lake,map:MAP_GLOBAL,title:'Center of Williams Lake'});self.spotList.forEach(function(spot){self.buildMarker(spot);});self.largeInfowindow=new google.maps.InfoWindow();self.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.POLYGON,drawingControl:true,drawingControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT,drawingModes:[google.maps.drawing.OverlayType.POLYGON]}});self.drawingManager.addListener('overlaycomplete',function(event){if(self.polygon){self.polygon.setMap(null);self.hideMarkers(self.placeMarkers());} self.drawingManager.setDrawingMode(null);self.polygon=event.overlay;self.polygon.setEditable(true);self.polygon.setDraggable(true);self.searchWithinPolygon();self.polygon.getPath().addListener('set_at',function(){self.searchWithinPolygon();});self.polygon.getPath().addListener('insert_at',function(){self.searchWithinPolygon();});});directionsService=new google.maps.DirectionsService();};this.mapLoadError=function(){var load_error_mes="Ooops!nThere seems to be a problem loading the map.n"+"Should I try again?";console.log("Map Load Error");if(window.confirm(load_error_mes)===true){console.log("---re-load");var script=document.createElement("script");script.type="text/javascript";script.src="https://maps.googleapis.com/maps/api/js?"+"key=AIzaSyB1Vs3ktrsweXIEICK-axcOk_Smy7-plgU&"+"libraries=drawing,geometry,places&v=3&callback=view_model.initMap";script.onerror="view_model.mapLoadError()";$('#map-script').empty().append(script);}};this.getPlacesDetails=function(marker,detailInfoWindow){var service=new google.maps.places.PlacesService(MAP_GLOBAL);service.getDetails({placeId:marker.id},function(place,status){detailInfoWindow.marker=marker;var innerHTML='<div>';if(status===google.maps.places.PlacesServiceStatus.OK){if(place.name){innerHTML+='<strong>'+place.name+'</strong>';} if(place.formatted_address){innerHTML+='<br>'+place.formatted_address;} if(place.formatted_phone_number){innerHTML+='<br>'+place.formatted_phone_number;} if(place.opening_hours){innerHTML+='<br><br><strong>Hours:</strong><br>'+ place.opening_hours.weekday_text[0]+'<br>'+ place.opening_hours.weekday_text[1]+'<br>'+ place.opening_hours.weekday_text[2]+'<br>'+ place.opening_hours.weekday_text[3]+'<br>'+ place.opening_hours.weekday_text[4]+'<br>'+ place.opening_hours.weekday_text[5]+'<br>'+ place.opening_hours.weekday_text[6]+'<br>';} if(place.photos){innerHTML+='<br><br><img src="'+place.photos[0].getUrl({maxHeight:100,maxWidth:200})+'">';}}else{innerHTML+='There are no Place details available at this time</div>';} detailInfoWindow.setContent(innerHTML);detailInfoWindow.open(map,marker);detailInfoWindow.addListener('closeclick',function(){detailInfoWindow.marker=null;});});};this.populateInfoWindow=function(spot){if(self.largeInfowindow.marker!==spot.marker){var content_html='<div>'+spot.marker.title+'</div>';var pano_html='<div id="pano"></div>';var foursquare_html='<div><br>Foursquare shows no spots near here</div>';self.largeInfowindow.marker=spot.marker;self.largeInfowindow.open(MAP_GLOBAL,spot.marker);var streetViewService=new google.maps.StreetViewService();var radius=50;function getStreetView(data,status){if(status===google.maps.StreetViewStatus.OK){var nearStreetViewLocation=data.location.latLng;var heading=google.maps.geometry.spherical.computeHeading(nearStreetViewLocation,spot.marker.position);var panoramaOptions={position:nearStreetViewLocation,pov:{heading:heading,pitch:10}};var panorama=new google.maps.StreetViewPanorama(document.getElementById('pano'),panoramaOptions);}else{pano_html='<div>No Street View Found</div>';self.largeInfowindow.setContent(content_html+pano_html+foursquare_html);}} function callbackFromFoursquare(){if(spot.closeTo().length>0){var tmp_html="";spot.closeTo().forEach(function(nearbyspot){tmp_html+="<li><strong>"+nearbyspot.type+" - </strong>"+nearbyspot.name+"</li>";});foursquare_html="<h3>According to Foursquare this is close to a</h3><ul>"+tmp_html+"</ul>";} streetViewService.getPanoramaByLocation(spot.marker.position,radius,getStreetView);self.largeInfowindow.setContent(content_html+pano_html+foursquare_html);self.largeInfowindow.open(MAP_GLOBAL,spot.marker);} while(spot.closeTo().length>0){spot.closeTo.pop();} this.queryFourSquare(spot,callbackFromFoursquare);}};this.displayDirections=function(toPosition){self.hideSpots();var originAddress=self.timeSearchText();var mode=self.selectedMode();directionsService.route({origin:originAddress,destination:toPosition,travelMode:google.maps.TravelMode[mode]},function(response,status){if(status===google.maps.DirectionsStatus.OK){var directionsDisplay=new google.maps.DirectionsRenderer({map:MAP_GLOBAL,directions:response,draggable:true,polylineOptions:{strokeColor:'green'}});self.routes.push(directionsDisplay);}else{window.alert('Directions request failed due to '+status);}});};};ViewModel.prototype.toggleSubMenu=function(data,event){var self=this;var sub=$(event.target).next();$(sub).slideToggle(function(){var isVis=$(sub).is(':visible');var arrow=$(event.target).children('span');if(isVis){arrow.text(self.UPARROW);}else{arrow.text(self.DOWNARROW);}});if(event.target.id==="nearby-h3") {self.clearNearbyList();self.spotList.forEach(function(spot){if(spot.selected){self.queryFourSquare(spot);}});}};ViewModel.prototype.makeMarkerIcon=function(markerColor){var markerImage=new google.maps.MarkerImage('http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+markerColor+'|40|_|%E2%80%A2',new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34),new google.maps.Size(21,34));return markerImage;};ViewModel.prototype.buildMarker=function(targetSpot){var self=this;var geocoder=new google.maps.Geocoder();if(targetSpot.address()===''){window.alert('Address: '+targetSpot.address()+', is not valid.');}else{geocoder.geocode({address:targetSpot.address()},function(results,status){if(status===google.maps.GeocoderStatus.OK){targetSpot.geoLocation(results[0].geometry.location);var icon=self.makeMarkerIcon(targetSpot.markerColor);var marker=new google.maps.Marker({map:MAP_GLOBAL,position:targetSpot.geoLocation(),title:targetSpot.name(),icon:icon,animation:google.maps.Animation.DROP});var hoverOverIcon=self.makeMarkerIcon(targetSpot.markerHighlightColor);marker.addListener('mouseover',function(){this.setIcon(hoverOverIcon);self.pulseMenuListItem(targetSpot.id);self.settleMarkers();});marker.addListener('mouseout',function(){this.setIcon(icon);});marker.addListener('click',function(){self.populateInfoWindow(targetSpot);targetSpot.marker.setAnimation(google.maps.Animation.BOUNCE);});targetSpot.marker=marker;}else{window.alert('Could not find that location - try entering a more specific place');}});}};ViewModel.prototype.settleMarkers=function(){var self=this;self.spotList.forEach(function(spot){if(spot.marker.getAnimation()===google.maps.Animation.BOUNCE){spot.marker.setAnimation(google.maps.Animation.DROP);}});};ViewModel.prototype.listClickHandler=function(spot){var self=this;self.settleMarkers();var vis=spot.markerVisible();this.shakeNameMarker(spot);var clicks=spot.clickCount();spot.clickCount(++clicks);if(!vis){spot.markerVisible(true);} this.populateInfoWindow(spot);};ViewModel.prototype.menuListMouseout=function(spot){if(spot.markerVisible()){var icon=this.makeMarkerIcon(spot.markerColor);spot.marker.setIcon(icon);}};ViewModel.prototype.menuListHover=function(spot){if(spot.markerVisible()){var icon=this.makeMarkerIcon(spot.markerHighlightColor);spot.marker.setIcon(icon);} this.pulseMenuListItem(spot.id);};ViewModel.prototype.pulseMenuListItem=function(id){$("#menu-list-"+id).animate({fontSize:"1.5em"});$("#menu-list-"+id).animate({fontSize:"1em"});};ViewModel.prototype.shakeNameMarker=function(spot){var self=this;if(!spot.marker.getMap()){spot.marker.setMap(MAP_GLOBAL);} spot.marker.setAnimation(google.maps.Animation.BOUNCE);self.currentSpot(self.spotList[spot.id]);};ViewModel.prototype.showSpots=function(){var mapBounds=new google.maps.LatLngBounds();this.spotList.forEach(function(spot){spot.marker.setMap(MAP_GLOBAL);mapBounds.extend(spot.marker.position);});MAP_GLOBAL.setCenter(mapBounds.getCenter());MAP_GLOBAL.fitBounds(mapBounds);};ViewModel.prototype.hideSpots=function(){this.spotList.forEach(function(spot){spot.marker.setMap(null);spot.marker.setAnimation(google.maps.Animation.DROP);});};ViewModel.prototype.hideMarkers=function(markers){markers.forEach(function(marker){marker.setMap(null);});};ViewModel.prototype.toggleDrawing=function(){var self=this;if(this.drawingManager.map){this.drawingManager.setMap(null);if(this.polygon){this.polygon.setMap(null);self.filteredSpotList.removeAll();self.spotList.forEach(function(spot){self.filteredSpotList.push(spot);});} this.sketchToggleValue(this.DRAWPOLY);}else{this.drawingManager.setMap(MAP_GLOBAL);this.sketchToggleValue(this.CLEARPOLY);}};ViewModel.prototype.zoomToArea=function(){var self=this;var geocoder=new google.maps.Geocoder();if(this.timeSearchText()===''){window.alert('Please ad an area or address');}else{geocoder.geocode({address:this.timeSearchText()},function(results,status){if(status==google.maps.GeocoderStatus.OK){MAP_GLOBAL.setCenter(results[0].geometry.location);if(!self.zoomed){self.zoomed=true;self.zoomText=self.ZOOMOUT;MAP_GLOBAL.setZoom(16);}else{self.zoomed=false;self.zoomText=(self.ZOOMIN);MAP_GLOBAL.setZoom(13);}}else{window.alert('Could not find that location - try entering a more specific place');}});}};ViewModel.prototype.displayMarkersWithinTime=function(response){var self=this;var origins=response.originAddresses;var destinations=response.destinationAddresses;var atLeastOne=false;var i=0;response.rows.forEach(function(results){var mapBounds=new google.maps.LatLngBounds();results.elements.forEach(function(result){var distanceText=null;if(result.distance){distanceText=result.distance.text;}else{window.alert("There are no cool spots in that area.");return;} var duration=result.duration.value/60;var durationText=result.duration.text;if(duration<=self.selectedTime()){var marker=null;if(i<self.spotList.length){marker=self.spotList[i].marker;marker.setMap(MAP_GLOBAL);mapBounds.extend(marker.position);} atLeastOne=true;var infowindow=new google.maps.InfoWindow({content:durationText+' away, about '+distanceText+'<div><button type="button" id="display-directions" onClick='+'"view_model.displayDirections(&quot;'+destinations[i]+'&quot;);">View Route</button></div>'});if(marker){self.spotList[i].marker.infowindow=infowindow;google.maps.event.addListener(marker,'click',function(){marker.infowindow.close();});} infowindow.open(MAP_GLOBAL,marker);} i=i+1;});MAP_GLOBAL.fitBounds(mapBounds);});if(!atLeastOne){window.alert('Sorry, nothing found within your selected time window.');}};ViewModel.prototype.searchWithinPolygon=function(){var self=this;var tempFilteredList=[];self.spotList.forEach(function(spot){if(google.maps.geometry.poly.containsLocation(spot.marker.position,self.polygon)){spot.marker.setMap(MAP_GLOBAL);self.spotTitle(self.defaultSpotTitle+' (filtered)');tempFilteredList.push(spot);}else{spot.marker.setMap(null);}});if(tempFilteredList.length>0){self.spotTitle(self.defaultSpotTitle+' (filtered)');self.filteredSpotList.removeAll();tempFilteredList.forEach(function(fspot){self.filteredSpotList.push(fspot);});}};ViewModel.prototype.searchWithinTime=function(){var self=this;var distanceMatrixService=new google.maps.DistanceMatrixService;if(this.timeSearchText()===''){window.alert('You need to enter an address');}else{this.hideSpots();var destinations=[];this.spotList.forEach(function(spot){destinations.push(spot.marker.position);});var origin=this.timeSearchText();var mode=this.selectedMode();distanceMatrixService.getDistanceMatrix({origins:[origin],destinations:destinations,travelMode:google.maps.TravelMode[mode],unitSystem:google.maps.UnitSystem.IMPERIAL,},function(response,status){if(status!==google.maps.DistanceMatrixStatus.OK){window.alert("Error was: "+status);}else{var originList=response.originAddresses;var destinationList=response.destinationAddresses;self.displayMarkersWithinTime(response);}});}};ViewModel.prototype.clearRoutes=function(){this.routes().forEach(function(route){route.setOptions({suppressMarkers:true});route.setMap(null);});this.routes.removeAll();};ViewModel.prototype.createMarkersForPlaces=function(places){var self=this;var mapBounds=new google.maps.LatLngBounds();places.forEach(function(place){var icon={url:place.icon,size:new google.maps.Size(35,35),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(15,34),scaledSize:new google.maps.Size(25,25)};var marker=new google.maps.Marker({map:MAP_GLOBAL,icon:icon,title:place.name,position:place.geometry.location,id:place.place_id});var placeInfoWindow=new google.maps.InfoWindow();marker.addListener('click',function(){if(placeInfoWindow.marker===this){}else{getPlacesDetails(this,placeInfoWindow);}});self.placeMarkers().push(marker);if(place.geometry.viewport){mapBounds.union(place.geometry.viewport);}else{mapBounds.extend(place.geometry.location);} MAP_GLOBAL.setCenter(mapBounds.getCenter());MAP_GLOBAL.fitBounds(mapBounds);});};ViewModel.prototype.queryFourSquare=function(querySpot,callback){var self=this;var client_id="INWUJQCSABPNKFZPFSG1L1023VTHBFWBP4YZCUXUFQEO01MW";var client_secret="T5RHEMNEQBGGQ4ZYF5ESD4NA1J20OWGD5IWTFYT5R4N21JZX";var ver="20161016";var query="";var location=querySpot.marker.position.lat()+","+querySpot.marker.position.lng();var url="https://api.foursquare.com/v2/venues/search";$.getJSON(url,{"v":ver,"ll":location,"query":query,"limit":5,"intent":"checkin","client_id":client_id,"client_secret":client_secret}).done(function(data){if(data.response.venues.length>0){data.response.venues.forEach(function(venue){var category_name="No Category";if(venue.categories.length>0) {venue.categories.forEach(function(category){console.log("- "+category.name);category_name=category.name;});} var nearbySpot={name:venue.name,type:category_name,address:venue.location.address,geoLocation:venue.location.lat+","+venue.location.lng,imgSrc:'',imgAttribution:''};self.addNearbySpots(nearbySpot);querySpot.closeTo.push(nearbySpot);});}else{window.alert("Sorry there was no information available for that search.");} if(callback!==null) {callback();}}).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;window.alert("Sorry there was an error in the Foursquare query: "+err);});};ko.applyBindings(new ViewModel());